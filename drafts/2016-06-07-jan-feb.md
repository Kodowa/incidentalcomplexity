---
layout: post
title: "Eve Dev Diary (Jan - Feb)"
author: "Corey Montella"
tags: []
---

At the start of 2016 we decided it was about time for another "release". I say "release" since we are developing in the open (for now, that's happening on our [Github](http://www.github.com/witheve). In January, our cadence was still very research-focused, but it had been almost 6 months since we [released V0](http://www.chris-granger.com/2015/08/17/version-0/). So we targeted February to showcase our next direction to the public.

### Platform Work

In October, Chris wrote a new runtime in TypeScript for his CardWiki experiment. Our V0 runtime was written in Rust, which was fine except for the distribution part of the story; with TypeScript, we can ship the runtime to the client's browser and have it do all the work. This was a lot easier compared to having the user download and install Rust, compile the runtime, and then compile and connect to a server. All of the proceeding work referrs to the TypeScript 

### Syntax

Eve has been missing a syntax for a while, but we abanonded it in 2015. You can check out the last syntax on [Github](https://github.com/witheve/Eve/tree/syntax/), or see it in action in a [previous post](http://incidentalcomplexity.com/2014/12/01/nov/). Our theory at the time was that Eve is a language for non-programmers, therefore we should use it as our users would i.e. without a syntax.

Thus, as we developed the [Foursquare clone](http://incidentalcomplexity.com/2015/07/02/mar-jun/), V0, and the [madlibs editor](http://incidentalcomplexity.com/2015/10/15/jul-sept/), we had no formal syntax for Eve. As we've learned, this was probably not a good idea for several reasons. 

1. Testing - Writing tests for a GUI is hard, especially when both the user interface and the runtime are constantly changing. Thus, we had no way to verify that a change in the runtime wouldn't break the client, or vice versa. 
2. Sharing - Sharing graphical coce is not impossible, but you first have to figure out what it is you're sharing. For us, this was very much a problem, because our ideas behind the meaning of code in a GUI was constantly in flux. With a syntax, you share text code and you're done. 
3. Bug reporting/reproducing - This is a combination of (1) and (2), but is sinister in its own right. If you find a bug in the client, you fist have to reproduce it. For a GUI client, this is problematic due to issues as mundane as screen resolution and DPI, browser version, or the size of a window. Once you've reproduced the bug, now you have to share the steps with a team member. How? Do you make a video? Do you write a detailed list of instructions? With a syntax, you just copy and paste the code and you're done. 

So by Januray 2016, we decided to invest in a syntax, as it would pay dividends by ameliorating the above. Let's take a look at how it works:

```
(query
	(select "eavs" :entity "corey" :attribute "age" :value corey|age)
	(project! "corey's age" :age corey|age))
```

Here is an Eve program that returns an attribute `age` for an entity `corey`. Each statement in an Eve program is a symbolic expression (s-exp) that starts with the keyword `query`. A `query` can contain any number of s-exps, which can be a `select`, a `project!`, or another `query`. 

Select statements ask Eve to find all data in a table with the specified fields. Here, the table is `"eavs"` and the fields are `entity`, `attribute`, and `value`. Fields may be bound or unbound. In this case `entity` is bound to `"corey"` and `attribute` is bound to `"age"`. However, `value` is left unbound, and is actually aliased as `corey|age`.

Project (the verb, not the noun) statements insert data into a new table, in this case `"corey's age"`. A new field is created called `age`, which is bound to `corey|age`.

Okay, that's fine. Let's look at something a little more complicated:  

```
(query
	(select "eavs" :entity :attribute "salary" :value salary)
	(select "sum" :sum output0 :input salary)
	(project! :sum-of-salaries output0))
```

This program selects every salary in Eve, sums them together, and projects that value into a new table. The first thing to note is on line 2, where `entity` is unbound. This select says "get all entities in the system that have an attribute salary". Thus, we would expect the variable `salary` to be a set of salaries in the system e.g. `{$10, $11, $15}`.


The only material difference between this program and the last is the third line. Here, "sum" is a special primitive table that's really an aggregate (known as a fold or reduce in other contexts). Sum takes whatever is bound to `input` and aggregates that to a single value e.g. `{$36}`. 

This is notable because it is the first time we've been able to fit aggregates cleanly into the system. Aggregates are hard in our system because of how they operate; everything else transforms sets into sets. Aggregates collapse sets into a single value. So they've always existed as a sort of second class citizen that you have to call out specifically. But in this case, aggregates are just another relational table, like anything else.

### Natural Language Querying

As if Eve wasn't enough work already, we decided to add a natural language interface. While we recognized at the outset that natural language processing (NLP) is one of the hardest problems all of science and engineering, we couldn't resist its siren song. I mean, what could be better for non-programmers than the ability to write a program in plain English (or their native language of choice)? Think what that would mean for the accessibility of a language. 


 But we thought we had a sufficiently constrained version of the problem that perhaps we had a shot at it. Let me explain...

Typical NLP tasks include machine translation, article summarization, sentiment analysis, part-of-speech tagging, coreference resolution, and named entity recognition. Today's best approaches train a classifier using a large corpus of annotated training text. Depending on the text and task, performance ranges from impressive (POS tagging, coreference resolution) to spotty (article summarization, sentiment analysis).

Our NLP task was very specific: to turn a plain english query into a formal query recognized by the Eve. Thus, we leveraged a number of assumption that simplified the problem to what we hoped was something tractable.   

1. We only had to deal with a single class of text: questions, no longer than a sentence, so we didn't have to deal with trying to understand a whole news article, for example.
2. Users could only ask about entities in the Eve database, so entity recognition was just a lookup.
3. People typically ask questions in a limited number of ways, which are typically concise. We didn't worry about flowery language or complex sentence structure.
4. Again, since you can only ask questions about data in the database, any ambiguities could be enumerated and presented to the user. 

Thus, we hoped we could just rely on a set of heuristics, which we could write to cover the general cases and then refine over time to get the edge cases. For instance, the query `"What is Corey's age?"` would be transformed into the s-exp we showed in the last section: 

```
(query
	(select "eavs" :entity "corey" :attribute "age" :value corey|age)
	(project! "corey's age" :age corey|age))
```

How does this work? 
















`total salary per department`

```
(query
	(select "tags" :entity department :tag "department")
	(query
		(select "eavs" :entity employee :attribute "salary" :value employee|salary)
		(select "eavs" :entity employee :attribute "department" :value department)
		(select "tags" :entity employee :tag "employee")
		(select "tags" :entity department :tag "department")
		(select "sum" :sum output0 :value employee|salary))
	(project! :sum output0 :department department))
```


`count the number of moons per planet`

```
(query
	(select "tags" :entity planet :tag "planet")
	(query
		(select "directionless links" :entity moon :link planet)
		(select "tags" :entity moon :tag "moon")
		(select "tags" :entity planet :tag "planet")
		(select "count" :count output0))
	(project! :count output0 :planet planet))
```



### WikiEve

![WikiEve](../images/wikieve1.gif)

![WikiEve](../images/wikieve2.gif)

![WikiEve](../images/wikieve3.png)

![WikiEve](../images/wikieve4.gif)

![WikiEve](../images/wikieve5.gif)